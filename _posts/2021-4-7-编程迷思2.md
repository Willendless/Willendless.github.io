---
layout: "post"
title: 编程迷思（二）
author: LJR
category: thinking
---

> 寻址模式是机器码操作数到指令操作数的映射

## 1. 二分

二分法解leetcode中有序数组循环移位有感：

二分的本质在于每次以常数时间将解空间分割为两部分，并由单调性判断解**一定/一定不**位于其中一解空间中。给出粗体强调的意义在于，有的时候只能做出一种情况的判断，但是也能二分。

## 2. 最小化接口

实现Mailbox和GPU间通信的消息缓存格式Tag抽象有感:

当半结构化数据无法完美使用数据结构表示的时候。例如消息缓存，其本身长度是不确定的，同时内部的Tag长度也不确定。

可以考虑最小化导出一个虚拟结构体接口，要求用户构造该结构体以提供必需的数据。模块内部根据用户提供的数据构造最终的结构体。

## 3. 寻址模式

指令集体系架构作为软硬件的接口，对它的理解需要从接口使用上（**汇编代码**）和实现上（**机器代码**）两个角度去理解，事实上所有抽象机制都要从这两个角度理解，也包括实现模拟器：

### 3.1. 寻址模式是什么意思，这里的址表示谁的地址？

+ 答案：寻址模式指的是硬件**根据机器码操作数** 计算 **指令操作数地址**的方式。
+ 区分机器码操作数和指令操作数非常有必要
  + 考虑一个6502中的指令`LDA`，这条指令的意思是将一个字节的数据装载到系统累加器寄存器中。
    + 指令操作数: 单字节数据
    + 机器码操作数: 可能有多种，但可以从总体上分为访存和不访存两类
      + 不访存
        + 立即数
      + 直接内存地址
      + 间接内存地址（间接内存地址还有多种）
+ **结论：寻址模式就是机器码操作数到指令操作数的映射**
  + 立即数 => 指令中编码立即数，地址即pc
  + 零页内存 => 指令中编码零页地址
  + 绝对内存 => 指令中编码绝对内存地址
  + ...

### 3.2. CPU如何知道使用的是哪种寻址模式

+ 答案：通过指令**opcode**字段知道。

### 3.3. 对模拟器的编写者的影响

+ 首先通过指令的opcode字段解析寻址模式/地址计算方式。
+ 然后根据指令操作数计算地址。
+ 最后根据地址获取操作数并执行指令。

### 3.4. 为什么会逐渐混淆

RISC架构中，寻址模式较少，一般只有五种。且一条指令一般对应只有一种寻址模式。

CISC架构中，寻址模式很多，且一条指令可以对应有多种寻址模式，也就是多种opcode。其实是多条指令。

其实从这点也可以看出，寻址模式越少，越能高效地架构流水线。同一条指令，意味着指令逻辑操作相同（比如都是加法，都是load到寄存器），但是寻址模式一多，光是指令操作数获取这一步差异就很大，有的直接解码就能获取，有的要访存，有的要访存加计算，有的计算加访存，因此延迟差异就大，如果架构流水线，流水线频率就上不去，或者根本流不起来可能这就是所谓的不规整吧。
